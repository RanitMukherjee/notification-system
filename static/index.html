<!DOCTYPE html>
<html>
<head>
  <title>Alert Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="p-6 bg-gray-50">
  <div x-data="alertApp()" x-init="loadAlerts(); setInterval(loadAlerts, 30000)">
    <h1 class="text-2xl font-bold mb-4">Admin Alert Dashboard</h1>

    <!-- Create Alert Form -->
    <div class="bg-white p-4 rounded mb-6">
      <h2 class="text-lg font-semibold mb-2">Create Alert</h2>
      <input x-model="newAlert.title" placeholder="Title" class="border p-2 w-full mb-2">
      <textarea x-model="newAlert.message" placeholder="Message" class="border p-2 w-full mb-2"></textarea>
      <select x-model="newAlert.severity" class="border p-2 mb-2">
        <option value="info">Info</option>
        <option value="warning">Warning</option>
        <option value="critical">Critical</option>
      </select>
      <select x-model="newAlert.audience_type" class="border p-2 mb-2">
        <option value="org">Organization</option>
        <option value="team">Team</option>
        <option value="user">User</option>
      </select>
      <input x-show="newAlert.audience_type !== 'org'" x-model="newAlert.audience_ids_str" placeholder="IDs (comma separated)" class="border p-2 w-full mb-2">
      <button @click="createAlert" class="bg-blue-500 text-white px-4 py-2 rounded">Create</button>
    </div>

    <!-- Alerts List -->
    <div>
      <h2 class="text-lg font-semibold mb-2">Active Alerts</h2>
      <template x-for="alert in alerts" :key="alert.id">
        <div class="bg-white p-4 mb-3 rounded shadow">
          <h3 class="font-bold" x-text="alert.title"></h3>
          <p x-text="alert.message"></p>
          <span :class="{
            'text-blue-600': alert.severity === 'info',
            'text-yellow-600': alert.severity === 'warning',
            'text-red-600': alert.severity === 'critical'
          }" x-text="alert.severity"></span>
          <span class="ml-2 text-sm text-gray-500" x-text="`Audience: ${alert.audience_type}`"></span>
        </div>
      </template>
    </div>
  </div>

  <script>
    function alertApp() {
      return {
        alerts: [],
        newAlert: {
          title: '',
          message: '',
          severity: 'info',
          audience_type: 'org',
          audience_ids_str: ''
        },
        async loadAlerts() {
          const res = await fetch('/admin/alerts');
          this.alerts = await res.json();
        },
        async createAlert() {
          const payload = { ...this.newAlert };
          if (payload.audience_ids_str) {
            payload.audience_ids = payload.audience_ids_str.split(',').map(id => parseInt(id.trim()));
          }
          await fetch('/admin/alerts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          this.newAlert = { title: '', message: '', severity: 'info', audience_type: 'org', audience_ids_str: '' };
          this.loadAlerts();
        }
      }
    }
  </script>
</body>
</html>